apiVersion: tekton.dev/v1beta1
kind: Pipeline
metadata:
  name: modelcar-pipeline
spec:
  params:
    - name: HUGGINGFACE_MODEL
      type: string
      description: "The Hugging Face model repository (e.g., ibm-granite/granite-3.2-2b-instruct)"
    - name: HUGGINGFACE_ALLOW_PATTERNS
      type: string
      description: 'Optional array of file patterns to allow default: "*.safetensors", "*.json", "*.txt"'
      default: ""
    - name: MODEL_NAME
      type: string
      description: "Name of the model to register in the model registry"
    - name: MODEL_VERSION
      type: string
      description: "Version of the model to register"
      default: "1.0.0"
    - name: MODEL_REGISTRY_URL
      type: string
      description: "URL of the model registry service"
    - name: S3_BUCKET
      type: string
      description: "S3 bucket name for model storage"
      default: "models"
    - name: S3_ENDPOINT_URL
      type: string
      description: "S3 endpoint URL (for MinIO or S3-compatible storage)"
      default: ""
  workspaces:
    - name: shared-workspace
    - name: s3-credentials
  tasks:
    - name: cleanup-workspace
      taskSpec:
        workspaces:
          - name: shared-workspace
        steps:
          - name: cleanup
            image: registry.access.redhat.com/ubi8/ubi-minimal:latest
            securityContext:
              runAsUser: 1001
            script: |
              #!/bin/sh
              set -e
              echo "Developed by the Red Hat AI Customer Adoption and Innovation team (CAI)"
              echo "Cleaning up workspace..."
              rm -rf /workspace/shared-workspace/model
              echo "Setting workspace permissions..."
              mkdir -p /workspace/shared-workspace/model
              chown -R 1001:1001 /workspace/shared-workspace/model
              chmod -R 755 /workspace/shared-workspace/model
              echo "Workspace cleanup complete!"
      workspaces:
        - name: shared-workspace
          workspace: shared-workspace
    - name: pull-model-from-huggingface
      taskSpec:
        workspaces:
          - name: shared-workspace
        params:
          - name: HUGGINGFACE_MODEL
          - name: HUGGINGFACE_ALLOW_PATTERNS
            type: string
            default: ""
        steps:
          - name: download-model
            image: quay.io/hayesphilip/huggingface-modelcar-builder:latest
            securityContext:
              runAsUser: 1001
            resources:
              limits:
                memory: "16Gi"
                cpu: "2"
              requests:
                memory: "8Gi"
                cpu: "1"
            env:
              - name: HUGGINGFACE_TOKEN
                valueFrom:
                  secretKeyRef:
                    name: huggingface-secret
                    key: HUGGINGFACE_TOKEN
                    optional: true
            script: |
              #!/bin/sh
              set -e
              echo "Developed by the Red Hat AI Customer Adoption and Innovation team (CAI)"
              echo "Downloading model from Hugging Face..."
              mkdir -p /workspace/shared-workspace/model

              CMD="python download_model.py -m $(params.HUGGINGFACE_MODEL) -t /workspace/shared-workspace/model"

              if [ ! -z "$HUGGINGFACE_TOKEN" ]; then
                CMD="$CMD --token $HUGGINGFACE_TOKEN"
              fi

              if [ ! -z "$(params.HUGGINGFACE_ALLOW_PATTERNS)" ]; then
                CMD="$CMD --allow-patterns $(params.HUGGINGFACE_ALLOW_PATTERNS)"
              fi

              eval $CMD
              echo "Download complete!"

              # Remove cache if exists
              if [ -d /workspace/shared-workspace/model/.cache ]; then
                echo "Removing cache..."
                rm -rf /workspace/shared-workspace/model/.cache
              fi

              echo "Model directory structure:"
              echo "------------------------"
              ls -lah /workspace/shared-workspace/model
              echo ""

              if [ -f /workspace/shared-workspace/model/config.json ]; then
                echo "Config.json found"
              else
                echo "Warning: config.json not found in model directory"
              fi
      params:
        - name: HUGGINGFACE_MODEL
          value: $(params.HUGGINGFACE_MODEL)
        - name: HUGGINGFACE_ALLOW_PATTERNS
          value: $(params.HUGGINGFACE_ALLOW_PATTERNS)
      workspaces:
        - name: shared-workspace
          workspace: shared-workspace
      runAfter:
        - cleanup-workspace
    - name: upload-model-to-s3
      taskSpec:
        workspaces:
          - name: shared-workspace
          - name: s3-credentials
        params:
          - name: MODEL_NAME
          - name: MODEL_VERSION
          - name: S3_BUCKET
          - name: S3_ENDPOINT_URL
        steps:
          - name: upload-to-s3
            image: quay.io/hayesphilip/s3-uploader:latest
            securityContext:
              runAsUser: 1001
            env:
              - name: MODEL_NAME
                value: $(params.MODEL_NAME)
              - name: MODEL_VERSION
                value: $(params.MODEL_VERSION)
              - name: S3_BUCKET
                value: $(params.S3_BUCKET)
              - name: S3_ENDPOINT_URL
                value: $(params.S3_ENDPOINT_URL)
              - name: AWS_ACCESS_KEY_ID
                valueFrom:
                  secretKeyRef:
                    name: s3-credentials
                    key: AWS_ACCESS_KEY_ID
              - name: AWS_SECRET_ACCESS_KEY
                valueFrom:
                  secretKeyRef:
                    name: s3-credentials
                    key: AWS_SECRET_ACCESS_KEY
              - name: WORKSPACE_PATH
                value: /workspace/shared-workspace/model
            script: |
              #!/bin/bash
              set -e
              echo "Developed by the Red Hat AI Customer Adoption and Innovation team (CAI)"
              echo "Uploading model to S3..."
              python /usr/local/bin/upload_model.py
              echo "Upload to S3 complete!"
      params:
        - name: MODEL_NAME
          value: $(params.MODEL_NAME)
        - name: MODEL_VERSION
          value: $(params.MODEL_VERSION)
        - name: S3_BUCKET
          value: $(params.S3_BUCKET)
        - name: S3_ENDPOINT_URL
          value: $(params.S3_ENDPOINT_URL)
      workspaces:
        - name: shared-workspace
          workspace: shared-workspace
        - name: s3-credentials
          workspace: s3-credentials
      runAfter:
        - pull-model-from-huggingface
    - name: register-with-registry
      taskSpec:
        workspaces:
          - name: shared-workspace
        params:
          - name: MODEL_NAME
          - name: MODEL_VERSION
          - name: HUGGINGFACE_MODEL
          - name: S3_BUCKET
          - name: MODEL_REGISTRY_URL
        steps:
          - name: register-model
            image: quay.io/hayesphilip/modelcar-register:latest
            script: |
              #!/bin/bash
              set -e
              echo "Developed by the Red Hat AI Customer Adoption and Innovation team (CAI)"
              echo "Running S3 model registration script..."
              python /workspace/register_s3_model.py
              echo "Registration complete!"
            volumeMounts:
              - name: register-s3-script
                mountPath: /workspace/register_s3_model.py
                subPath: register_s3_model.py
            env:
              - name: MODEL_NAME
                value: $(params.MODEL_NAME)
              - name: MODEL_VERSION
                value: $(params.MODEL_VERSION)
              - name: HUGGINGFACE_MODEL
                value: $(params.HUGGINGFACE_MODEL)
              - name: S3_BUCKET
                value: $(params.S3_BUCKET)
              - name: MODEL_REGISTRY_URL
                value: $(params.MODEL_REGISTRY_URL)
              - name: CLUSTER_DOMAIN
                value: "cluster.local"
        volumes:
          - name: register-s3-script
            configMap:
              name: register-s3-script
      params:
        - name: MODEL_NAME
          value: $(params.MODEL_NAME)
        - name: MODEL_VERSION
          value: $(params.MODEL_VERSION)
        - name: HUGGINGFACE_MODEL
          value: $(params.HUGGINGFACE_MODEL)
        - name: S3_BUCKET
          value: $(params.S3_BUCKET)
        - name: MODEL_REGISTRY_URL
          value: $(params.MODEL_REGISTRY_URL)
      workspaces:
        - name: shared-workspace
          workspace: shared-workspace
      runAfter:
        - upload-model-to-s3
