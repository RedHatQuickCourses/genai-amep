apiVersion: tekton.dev/v1beta1
kind: Pipeline
metadata:
  name: modelcar-pipeline
spec:
  params:
    - name: HUGGINGFACE_MODEL
      type: string
      description: "The Hugging Face model repository (e.g., ibm-granite/granite-3.2-2b-instruct)"
    - name: HUGGINGFACE_ALLOW_PATTERNS
      type: string
      description: 'Optional array of file patterns to allow default: "*.safetensors", "*.json", "*.txt"'
      default: ""
    - name: COMPRESS_MODEL
      type: string
      description: "Whether to compress the model using llmcompressor (true/false)"
      default: "false"
    - name: MODEL_NAME
      type: string
      description: "Name of the model to register in the model registry"
    - name: MODEL_VERSION
      type: string
      description: "Version of the model to register"
      default: "1.0.0"
    - name: SKIP_TASKS
      type: string
      description: "Comma-separated list of tasks to skip (e.g., 'cleanup-workspace,pull-model-from-huggingface,compress-model,upload-model-to-s3')"
      default: ""
    - name: MODEL_REGISTRY_URL
      type: string
      description: "URL of the model registry service"
    - name: S3_BUCKET
      type: string
      description: "S3 bucket name for model storage"
      default: "models"
    - name: S3_ENDPOINT_URL
      type: string
      description: "S3 endpoint URL (for MinIO or S3-compatible storage)"
      default: ""
  workspaces:
    - name: shared-workspace
    - name: s3-credentials
  tasks:
    - name: cleanup-workspace
      taskSpec:
        workspaces:
          - name: shared-workspace
        params:
          - name: SKIP_TASK
          - name: SKIP_TASKS
        steps:
          - name: cleanup
            image: registry.access.redhat.com/ubi8/ubi-minimal:latest
            securityContext:
              runAsUser: 1001
            script: |
              #!/bin/sh
              set -e
              echo "Developed by the Red Hat AI Customer Adoption and Innovation team (CAI)"
              if [[ ",$(params.SKIP_TASKS)," == *",$(params.SKIP_TASK),"* ]]; then
                echo "Skipping cleanup-workspace task"
                exit 0
              fi
              echo "Cleaning up workspace..."
              rm -rf /workspace/shared-workspace/model
              echo "Workspace cleanup complete!"
              echo "Setting workspace permissions..."
              mkdir /workspace/shared-workspace/model
              ls -la /workspace/shared-workspace
              chown -R 1001:1001 /workspace/shared-workspace/model
              chmod -R 755 /workspace/shared-workspace/model
              echo "Workspace cleanup complete!"
      params:
        - name: SKIP_TASK
          value: "cleanup-workspace"
        - name: SKIP_TASKS
          value: $(params.SKIP_TASKS)
      workspaces:
        - name: shared-workspace
          workspace: shared-workspace
    - name: pull-model-from-huggingface
      taskSpec:
        workspaces:
          - name: shared-workspace
        params:
          - name: HUGGINGFACE_MODEL
          - name: HUGGINGFACE_ALLOW_PATTERNS
            type: string
            default: ""
          - name: SKIP_TASK
          - name: SKIP_TASKS
        steps:
          - name: download-model
            image: quay.io/hayesphilip/huggingface-modelcar-builder:latest
            securityContext:
              runAsUser: 1001
            resources:
              limits:
                memory: "16Gi"
                cpu: "2"
              requests:
                memory: "16Gi"
                cpu: "2"
            env:
              - name: HUGGINGFACE_TOKEN
                valueFrom:
                  secretKeyRef:
                    name: huggingface-secret
                    key: HUGGINGFACE_TOKEN
                    optional: true
            script: |
              #!/bin/sh
              set -e
              echo "Developed by the Red Hat AI Customer Adoption and Innovation team (CAI)"
              if [[ ",$(params.SKIP_TASKS)," == *",$(params.SKIP_TASK),"* ]]; then
                echo "Skipping pull-model-from-huggingface task"
                exit 0
              fi
              echo "Downloading model from Hugging Face..."
              mkdir -p /workspace/shared-workspace/model
              CMD="python download_model.py -m $(params.HUGGINGFACE_MODEL) -t /workspace/shared-workspace/model --token $HUGGINGFACE_TOKEN"
              if [ ! -z "$(params.HUGGINGFACE_ALLOW_PATTERNS)" ]; then
                CMD="$CMD --allow-patterns $(params.HUGGINGFACE_ALLOW_PATTERNS)"
              fi
              eval $CMD
              echo "Download complete!"
              if [ -d /workspace/shared-workspace/model/.cache ]; then
                echo "Removing cache"
                rm -r /workspace/shared-workspace/model/.cache
              fi
              
              echo "Model directory structure:"
              echo "------------------------"
              ls -la /workspace/shared-workspace/model 
              echo
              
              if [ -f /workspace/shared-workspace/model/config.json ]; then
                echo "Config.json contents:"
                echo "--------------------"
                cat /workspace/shared-workspace/model/config.json
              else
                echo "Warning: config.json not found in model directory"
              fi
      params:
        - name: HUGGINGFACE_MODEL
          value: $(params.HUGGINGFACE_MODEL)
        - name: SKIP_TASK
          value: "pull-model-from-huggingface"
        - name: SKIP_TASKS
          value: $(params.SKIP_TASKS)
      workspaces:
        - name: shared-workspace
          workspace: shared-workspace
      runAfter:
        - cleanup-workspace
    - name: compress-model
      taskRef:
        name: compress-model
      timeout: 20h
      when:
        - input: $(params.COMPRESS_MODEL)
          operator: in
          values: ["true"]
        - input: $(params.SKIP_TASKS)
          operator: notin
          values: ["compress-model"]
      params:
        - name: COMPRESS_MODEL
          value: $(params.COMPRESS_MODEL)
        - name: SKIP_TASK
          value: "compress-model"
        - name: SKIP_TASKS
          value: $(params.SKIP_TASKS)
      workspaces:
        - name: shared-workspace
          workspace: shared-workspace
      runAfter:
        - pull-model-from-huggingface
    - name: upload-model-to-s3
      taskSpec:
        workspaces:
          - name: shared-workspace
          - name: s3-credentials
        params:
          - name: MODEL_NAME
          - name: MODEL_VERSION
          - name: S3_BUCKET
          - name: S3_ENDPOINT_URL
          - name: SKIP_TASK
          - name: SKIP_TASKS
        steps:
          - name: upload-to-s3
            image: quay.io/hayesphilip/s3-uploader:latest
            securityContext:
              runAsUser: 1001
            env:
              - name: MODEL_NAME
                value: $(params.MODEL_NAME)
              - name: MODEL_VERSION
                value: $(params.MODEL_VERSION)
              - name: S3_BUCKET
                value: $(params.S3_BUCKET)
              - name: S3_ENDPOINT_URL
                value: $(params.S3_ENDPOINT_URL)
              - name: AWS_ACCESS_KEY_ID
                valueFrom:
                  secretKeyRef:
                    name: s3-credentials
                    key: AWS_ACCESS_KEY_ID
              - name: AWS_SECRET_ACCESS_KEY
                valueFrom:
                  secretKeyRef:
                    name: s3-credentials
                    key: AWS_SECRET_ACCESS_KEY
              - name: WORKSPACE_PATH
                value: /workspace/shared-workspace/model
              - name: SKIP_TASK
                value: $(params.SKIP_TASK)
              - name: SKIP_TASKS
                value: $(params.SKIP_TASKS)
            script: |
              #!/bin/bash
              set -e
              echo "Uploading model to S3..."
              python /usr/local/bin/upload_model.py
      params:
        - name: MODEL_NAME
          value: $(params.MODEL_NAME)
        - name: MODEL_VERSION
          value: $(params.MODEL_VERSION)
        - name: S3_BUCKET
          value: $(params.S3_BUCKET)
        - name: S3_ENDPOINT_URL
          value: $(params.S3_ENDPOINT_URL)
        - name: SKIP_TASK
          value: "upload-model-to-s3"
        - name: SKIP_TASKS
          value: $(params.SKIP_TASKS)
      workspaces:
        - name: shared-workspace
          workspace: shared-workspace
        - name: s3-credentials
          workspace: s3-credentials
      runAfter:
        - compress-model
    - name: register-with-registry
      taskSpec:
        workspaces:
          - name: shared-workspace
        params:
          - name: MODEL_NAME
          - name: MODEL_VERSION
          - name: HUGGINGFACE_MODEL
          - name: S3_BUCKET
          - name: SKIP_TASK
          - name: SKIP_TASKS
          - name: MODEL_REGISTRY_URL
        steps:
          - name: register-model
            image: quay.io/hayesphilip/modelcar-register:latest
            script: |
              #!/bin/bash
              set -e
              echo "Running S3 model registration script..."
              python /workspace/register_s3_model.py
            volumeMounts:
              - name: register-s3-script
                mountPath: /workspace/register_s3_model.py
                subPath: register_s3_model.py
            env:
              - name: MODEL_NAME
                value: $(params.MODEL_NAME)
              - name: MODEL_VERSION
                value: $(params.MODEL_VERSION)
              - name: HUGGINGFACE_MODEL
                value: $(params.HUGGINGFACE_MODEL)
              - name: S3_BUCKET
                value: $(params.S3_BUCKET)
              - name: SKIP_TASK
                value: $(params.SKIP_TASK)
              - name: SKIP_TASKS
                value: $(params.SKIP_TASKS)
              - name: MODEL_REGISTRY_URL
                value: $(params.MODEL_REGISTRY_URL)
              - name: CLUSTER_DOMAIN
                value: "cluster.local"
        volumes:
          - name: register-s3-script
            configMap:
              name: register-s3-script
      params:
        - name: MODEL_NAME
          value: $(params.MODEL_NAME)
        - name: MODEL_VERSION
          value: $(params.MODEL_VERSION)
        - name: HUGGINGFACE_MODEL
          value: $(params.HUGGINGFACE_MODEL)
        - name: S3_BUCKET
          value: $(params.S3_BUCKET)
        - name: SKIP_TASK
          value: "register-with-registry"
        - name: SKIP_TASKS
          value: $(params.SKIP_TASKS)
        - name: MODEL_REGISTRY_URL
          value: $(params.MODEL_REGISTRY_URL)
      workspaces:
        - name: shared-workspace
          workspace: shared-workspace
      runAfter:
        - upload-model-to-s3
